---
title: 数据库
date: 2021-07-27 07:53:19
permalink: /pages/a1db83/
categories:
  - 插件开发
  - 快速入门
tags:
  - 
---

> 数据库也是一个常用的功能，通过数据库，我们可以存储一些有结构的数据，比如友链数据，用户赞助数据等等。

> 记得在auth里面加上 `database`

## 简介

博客系统的数据库采用的是MongoDB数据库。所以在你操作之前建议去看一下MongoDB的教程，比如这篇[MongoDB 教程 | 菜鸟教程 (runoob.com)](https://www.runoob.com/mongodb/mongodb-tutorial.html) 因为MongoDB有些操作和MySQL不一样，所以有些地方如果你没接触过MongoDB的话可能会很懵逼。

这里我简单介绍一下最基本的概念，MongoDB里面的对象对MySQL的数据库，集合对应MySQL的表。MongoDB与MySQL的最大区别就是MySQL的数据是表结构的，格式要求严格，而MongoDB存的是JSON格式，所以每行数据的结构都可以不一样。这种方式最大的好处就是存储数据非常的灵活，你可以存储任意结构的数据，而不用关心字段。

![image-20210728083650832](https://img.xiaoyou66.com/2021/07/28/b666374b5c4f9.png)



## 初始化集合

在使用数据库之前，我们需要初始化一个连接对象，建议集合名字作为常量放在最开始那一行，然后下面的`db`就是我们初始化后的对象。我们可以使用对象对数据库进行操作。

```JavaScript
// 获取API接口
const router =xBlog.router
const database = xBlog.database
// 数据库集合名
const dbTest = "test"
// 注册路由
router.registerRouter("GET","",function(context){
    // 初始化集合
    let db = database.newDb(dbTest)
    router.response.ResponseOk(context,{message:"ok"})
})

```

下面我将从增删改查这四个角度来分别说明

## 增加数据

```javascript
// 获取API接口
const router =xBlog.router
const database = xBlog.database
// 数据库集合名
const dbTest = "test"
// 注册路由
router.registerRouter("GET","",function(context){
    // 初始化集合
    let db = database.newDb(dbTest)
    // 插入数据
    db.InsertOne({name: "小游"},function (err,res){
        // 数据插入后的回调操作，可以通过err字段判断数据是否插入成功
        if (!err){
            router.response.ResponseOk(context,res)
        } else {
            router.response.ResponseServerError(context,err)
        }
    })
})
```

上面这段代码其实很好理解，我们调用`InsertOne`插入了一条数据，然后会通过回调的形式来通知你，这里我们需要判断一下`err`字段，如果执行没有错误的话，`err`就为空，我们返回操作成功的结果，如果执行有错误的话，那么我们就返回`err`内容，我们调用一下路由就会发现数据插入成功，返回了插入后的ID

![image-20210728084916545](https://img.xiaoyou66.com/2021/07/28/8a67cf465fee0.png)

然后我们查看一下数据库，可以发现，我们的值成功插入进去了

![image-20210728085036968](https://img.xiaoyou66.com/2021/07/28/93e406fd1b65b.png)

上面这个看起来很像MySQL的表，但是实际上，我们切换一下显示模式就可以看到原始的数据了

![image-20210728085149591](https://img.xiaoyou66.com/2021/07/28/f12c60275f1d1.png)

### 插入ID自增的数据

因为MongoDB的id是文档ID，ID长并且没有规律，而有时候我们又想使用MySQL的自增ID特性怎么办，使用`InsertOneIncrease` 函数，这个函数只需要指定一下那个key要增加就行。我们数据库操作代码如下：

```javascript
// 初始化集合
let db = database.newDb(dbTest)
// 插入数据
db.InsertOneIncrease({name: "小游"},"user_id",function (err,res){
    // 数据插入后的回调操作，可以通过err字段判断数据是否插入成功
    if (!err){
        router.response.ResponseOk(context,res)
    } else {
        router.response.ResponseServerError(context,err)
    }
})
```

下面这个是返回的结果

![image-20210728085622283](https://img.xiaoyou66.com/2021/07/28/7b77fdba474b8.png)

下面我们再看一下数据库，可以发现多了一个user_id的字段，并且自动设置为

![image-20210728085702997](https://img.xiaoyou66.com/2021/07/28/44a17d03035f8.png)

我们重复调用这个路由后，就可以发现，这个ID已经可以自动递增了，这样就可以实现一些需要自增ID的操作了

![image-20210728085758873](https://img.xiaoyou66.com/2021/07/28/a2a1d08dae8a1.png)

> 不过其实还是建议使用MongoDB的文档ID，默认的性能会快一些

## 删除数据

下面我们来删除一下数据

